resources:
- name: etcher-git
  type: git
  source:
    uri: https://github.com/resin-io/etcher.git
    branch: concourse-test
    disable_ci_skip: true

jobs:
- name: tests-darwin

  # Make the job results accessible to
  # un-authenticated users
  public: true

  plan:
  - get: etcher-git

    # Trigger this job if the resource has a new
    # version. If this is false, the job can only
    # be started from the web UI.
    trigger: true

  - task: dependencies
    config:
      platform: darwin
      inputs:
        - name: etcher-git
      outputs:
        - name: etcher-ready
      run:
        path: /bin/bash
        args:
          - -exc
          - |
            cp -a etcher-git/. etcher-ready
            ( cd etcher-ready && ./ci/install.sh )
            tar czf etcher-ready/node_modules/bin.tar.gz etcher-ready/node_modules/.bin

  - task: test
    config:
      platform: darwin
      inputs:
        - name: etcher-ready
      params:
        npm_config_unsafe_perm: true
      run:
        path: /bin/bash
        dir: etcher-ready
        args:
          - -exc
          - |
            tar fx ./node_modules/bin.tar.gz --strip-components 1
            rm ./node_modules/bin.tar.gz
            ./ci/test.sh

  - task: build-installers
    config:
      platform: darwin
      inputs:
        - name: etcher-ready
      run:
        path: /bin/bash
        dir: etcher-ready
        args:
          - -exc
          - |
            tar fx ./node_modules/bin.tar.gz --strip-components 1
            rm ./node_modules/bin.tar.gz
            ./ci/build-installers.sh
